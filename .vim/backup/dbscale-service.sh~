#!/bin/bash

PROG=dbscale
DBSCALE_PATH=/home/hu/sandboxes/dbscale # Need to modify
DBSCALE_PID_FILE=$DBSCALE_PATH/dbscale.pid
DBSCALE_PID=`cat $DBSCALE_PID_FILE 2>/dev/null`
START_TIMEOUT=60
STOP_TIMEOUT1=10
STOP_TIMEOUT2=5

force=0

check_pid() {
    [ -z $1 ] && return 1
    [ -d "/proc/$1" ] && return 0 || return 1
}

dbscale_start() {
    export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$DBSCALE_PATH/libs
    cd $DBSCALE_PATH

    echo 10240 > /proc/sys/net/ipv4/tcp_max_syn_backlog
    echo 10240 > /proc/sys/net/core/somaxconn
    ulimit -n 102400
    ulimit -c unlimited
    ./$PROG &
    DBSCALE_PID=$!
    sleep 1

    start_time=`date '+%s'`
    while true; do
        current_time=`date '+%s'`
        if (($current_time - $start_time > $START_TIMEOUT)); then # start time out
            return
        fi
        if [ ! -f "dbscale.pid" ]; then
            continue
        fi
        if [ "X$DBSCALE_PID" == "X"`cat dbscale.pid` ]; then
            return
        fi
    done
}

dbscale_stop() {
    kill -TERM $DBSCALE_PID >/dev/null 2>&1
    start_time=`date '+%s'`
    while true; do
        current_time=`date '+%s'`
        if (($current_time - $start_time > $STOP_TIMEOUT1)); then
            break
        fi
        if ! check_pid $DBSCALE_PID; then
            return
        fi
    done

    kill -KILL $DBSCALE_PID >/dev/null 2>&1
    sleep $STOP_TIMEOUT2
}

if [ ! -d "$DBSCALE_PATH" -o ! -f "$DBSCALE_PATH/$PROG" ]; then
    echo "The path of dbscale is not correct."
    exit 1
fi

case "$1" in
    start)
        if ! check_pid $DBSCALE_PID; then
            echo -e "Starting DBScale...\c"
            dbscale_start
            check_pid $DBSCALE_PID && echo "done." || echo "fail."
        else
            echo "DBScale has already been running."
        fi
        ;;
    stop)
        if check_pid $DBSCALE_PID; then
            echo -e "Stopping DBScale...\c"
            dbscale_stop
            check_pid $DBSCALE_PID && echo "fail." || echo "done."
        else
            echo "DBScale is not running."
        fi
        ;;
    status)
        if check_pid $DBSCALE_PID; then
            echo "DBScale is running."
            exit 0
        else
            echo "DBScale is not running."
            exit 1
        fi
        ;;
    *)
        echo "Usage: $0 {start|stop|status}"
        exit 1
esac
exit 0
